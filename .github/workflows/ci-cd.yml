name: CI/CD Pipeline for Healthcare Microservices

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # Step 1: Build and Push Docker Images in Parallel
  build_and_push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [patient-service, application-service, order-service]
    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install Azure CLI
      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az --version

      # Log in to Azure using Service Principal
      - name: Azure Login
        run: |
          az login --service-principal -u ${{ secrets.AZURE_USERNAME }} -p ${{ secrets.AZURE_PASSWORD }} --tenant ${{ secrets.AZURE_TENANT_ID }}

      # Login Docker to ACR
      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Cache Docker layers
      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # Build & push Docker image
      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/${{ matrix.service }}:${{ github.sha }} ./${{ matrix.service }}
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/${{ matrix.service }}:${{ github.sha }}

  # Step 2: Deploy services to AKS
  deploy_to_aks:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install Azure CLI
      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      # Azure Login
      - name: Azure Login
        run: |
          az login --service-principal -u ${{ secrets.AZURE_USERNAME }} -p ${{ secrets.AZURE_PASSWORD }} --tenant ${{ secrets.AZURE_TENANT_ID }}

      # Set up kubectl
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      # Get AKS credentials
      - name: Configure AKS
        run: |
          az aks get-credentials --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} --name ${{ secrets.AKS_CLUSTER_NAME }}

      # Deploy with Helm and inject secrets from Azure Key Vault
      - name: Deploy services via Helm
        run: |
          NAMESPACE=healthcare-dev
          kubectl create namespace $NAMESPACE || true

          for service in patient-service application-service order-service
          do
            echo "Deploying $service..."
            
            # Retrieve secrets from Azure Key Vault
            DB_PASSWORD=$(az keyvault secret show --vault-name ${{ secrets.KEYVAULT_NAME }} --name ${service}-db-password --query value -o tsv)

            # Deploy via Helm
            helm upgrade --install $service ./helm/$service \
              --namespace $NAMESPACE \
              --set image.repository=${{ secrets.ACR_NAME }}.azurecr.io/$service \
              --set image.tag=${{ github.sha }} \
              --set env.DB_PASSWORD=$DB_PASSWORD

            # Wait for deployment to complete
            kubectl rollout status deployment/$service -n $NAMESPACE
          done
